<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-01-10T11:13:27.844387"><title>S&eacute;curiser Kubernetes avec OPA Gatekeeper | WriteUpSecuCloud</title><script type="application/json" id="virtual-toc-data">[{"id":"contexte","level":0,"title":"Contexte","anchor":"#contexte"},{"id":"technologie","level":0,"title":"Technologie","anchor":"#technologie"},{"id":"introduction-sur-rego","level":0,"title":"Introduction sur Rego","anchor":"#introduction-sur-rego"},{"id":"introduction-sur-k8s-en-yaml","level":0,"title":"Introduction sur K8s (en yaml)","anchor":"#introduction-sur-k8s-en-yaml"},{"id":"application-d-une-r-gle-rego-sur-un-yaml-k8s","level":0,"title":"Application d\u0027une règle Rego sur un YAML K8s","anchor":"#application-d-une-r-gle-rego-sur-un-yaml-k8s"},{"id":"application-sur-l-instance","level":0,"title":"Application sur l\u0027instance","anchor":"#application-sur-l-instance"},{"id":"debug","level":0,"title":"Debug","anchor":"#debug"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="S&eacute;curiser Kubernetes avec OPA Gatekeeper | WriteUpSecuCloud"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="WriteUpSecuCloud Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/secure-kubernetes-using-opa-gatekeeper.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="S&eacute;curiser Kubernetes avec OPA Gatekeeper | WriteUpSecuCloud"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/secure-kubernetes-using-opa-gatekeeper.html#webpage",
    "url": "writerside-documentation/secure-kubernetes-using-opa-gatekeeper.html",
    "name": "S&eacute;curiser Kubernetes avec OPA Gatekeeper | WriteUpSecuCloud",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "WriteUpSecuCloud Help"
}</script><!-- End Schema.org --></head><body data-id="Secure-Kubernetes-using-OPA-Gatekeeper" data-main-title="Sécuriser Kubernetes avec OPA Gatekeeper" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="acceuil.md|Acceuil"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>WriteUpSecuCloud  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Secure-Kubernetes-using-OPA-Gatekeeper" id="Secure-Kubernetes-using-OPA-Gatekeeper.md">Sécuriser Kubernetes avec OPA Gatekeeper</h1><section class="chapter"><h2 id="contexte" data-toc="contexte">Contexte</h2><p id="h6a3s2_10">Votre entreprise a &eacute;t&eacute; engag&eacute;e par SuperTech, qui a r&eacute;cemment rencontr&eacute; des probl&egrave;mes de s&eacute;curit&eacute; avec ses clusters Kubernetes. <br> L'organisation a eu des difficult&eacute;s avec des d&eacute;ploiements mal configur&eacute;s et des param&egrave;tres de ressources non conformes, ce qui a entra&icirc;n&eacute; plusieurs incidents de s&eacute;curit&eacute;. <br><br> Pour r&eacute;soudre ces probl&egrave;mes, vous &ecirc;tes charg&eacute; d'aider &agrave; mettre en &oelig;uvre une solution robuste d'application des politiques &agrave; l'aide d'OPA Gatekeeper afin de garantir les points suivants :</p><dl id="h6a3s2_11" data-style="title-top"><dt id="h6a3s2_15" data-expandable="false"><span class="control" id="h6a3s2_21">Syst&egrave;me de fichiers en lecture seule</span></dt><dd><p id="h6a3s2_20">S'assurer que tous les pods utilisent un syst&egrave;me de fichiers en lecture seule pour emp&ecirc;cher les modifications non autoris&eacute;es.</p></dd><dt id="h6a3s2_16" data-expandable="false"><span class="control" id="h6a3s2_24">Escalade de privil&egrave;ges</span></dt><dd><p id="h6a3s2_23">Bloquer les pods o&ugrave; l'option <code class="code" id="h6a3s2_25">AllowPrivilegeEscalation</code> dans le contexte de s&eacute;curit&eacute; est d&eacute;finie sur <code class="code" id="h6a3s2_26">true</code>, ce qui pourrait permettre aux processus d'acqu&eacute;rir des privil&egrave;ges suppl&eacute;mentaires.</p></dd><dt id="h6a3s2_17" data-expandable="false"><span class="control" id="h6a3s2_29">Utilisation du r&eacute;seau de l'h&ocirc;te</span></dt><dd><p id="h6a3s2_28">Interdire l'utilisation de <code class="code" id="h6a3s2_30">hostNetwork: true</code> dans les sp&eacute;cifications des pods pour &eacute;viter d'exposer directement le pod au r&eacute;seau de l'h&ocirc;te, r&eacute;duisant ainsi le risque d'attaques au niveau r&eacute;seau.</p></dd><dt id="h6a3s2_18" data-expandable="false"><span class="control" id="h6a3s2_33">Restriction des volumes HostPath</span></dt><dd><p id="h6a3s2_32">Restreindre l'utilisation des volumes <code class="code" id="h6a3s2_34">hostPath</code> sur un pod Kubernetes.</p></dd></dl></section><section class="chapter"><h2 id="technologie" data-toc="technologie">Technologie</h2><section class="chapter"><h3 id="kubernetes-ou-k8s" data-toc="kubernetes-ou-k8s">Kubernetes (ou K8s)</h3><p id="h6a3s2_37">Kubernetes (souvent abr&eacute;g&eacute; en K8s) est une plateforme open source d'orchestration de conteneurs. <br> Elle automatise le d&eacute;ploiement, la mise &agrave; l'&eacute;chelle, la gestion et l'exploitation des applications conteneuris&eacute;es. <br><br> Tout ceci permet donc de g&eacute;rer des clusters de machines physiques ou virtuelles, assure une haute disponibilit&eacute; des applications et simplifie leur maintenance gr&acirc;ce &agrave; des concepts tels que les pods, les services et les d&eacute;ploiements.</p></section><section class="chapter"><h3 id="opa" data-toc="opa">OPA</h3><p id="h6a3s2_41">OPA (Open Policy Agent) est un moteur de r&egrave;gles g&eacute;n&eacute;raliste qui utilise le langage Rego pour d&eacute;finir et appliquer des politiques dans divers syst&egrave;mes tels que les microservices ou les pipelines CI/CD. <br><br> OPA Gatekeeper, quant &agrave; lui, est une extension sp&eacute;cifique &agrave; Kubernetes d&rsquo;OPA, fournissant une application des politiques et un contr&ocirc;le pour les clusters Kubernetes. <br> Bien qu&rsquo;OPA puisse &ecirc;tre int&eacute;gr&eacute; dans divers environnements, Gatekeeper est sp&eacute;cifiquement con&ccedil;u pour g&eacute;rer les ressources Kubernetes en utilisant des mod&egrave;les de contraintes et des contraintes pour appliquer des politiques directement dans l&rsquo;&eacute;cosyst&egrave;me K8s.</p><section class="chapter"><h4 id="opa-gatekeeper" data-toc="opa-gatekeeper">OPA Gatekeeper</h4><p id="h6a3s2_46">OPA Gatekeeper fonctionne comme un contr&ocirc;leur d'admission dans Kubernetes :</p><dl id="h6a3s2_47" data-style="title-top"><dt id="h6a3s2_48" data-expandable="false"><span class="control" id="h6a3s2_55">D&eacute;finition des politiques</span></dt><dd><p id="h6a3s2_54">Les politiques sont &eacute;crites en Rego et sp&eacute;cifient les r&egrave;gles auxquelles les ressources doivent se conformer.</p></dd><dt id="h6a3s2_49" data-expandable="false"><span class="control" id="h6a3s2_58">Mod&egrave;les de contraintes</span></dt><dd><p id="h6a3s2_57">Mod&egrave;les qui d&eacute;finissent le sch&eacute;ma des contraintes. Les contraintes pr&eacute;cisent quelles politiques appliquer et &agrave; quelles ressources.</p></dd><dt id="h6a3s2_50" data-expandable="false"><span class="control" id="h6a3s2_61">Contraintes</span></dt><dd><p id="h6a3s2_60">Instances des mod&egrave;les de contraintes qui appliquent des politiques sp&eacute;cifiques.</p></dd><dt id="h6a3s2_51" data-expandable="false"><span class="control" id="h6a3s2_64">Contr&ocirc;leur d'admission</span></dt><dd><p id="h6a3s2_63">Intercepte les requ&ecirc;tes envoy&eacute;es au serveur API Kubernetes et les &eacute;value par rapport aux contraintes d&eacute;finies.</p></dd><dt id="h6a3s2_52" data-expandable="false"><span class="control" id="h6a3s2_67">Audit</span></dt><dd><p id="h6a3s2_66">V&eacute;rifie p&eacute;riodiquement les ressources existantes pour s'assurer qu'elles sont conformes aux contraintes d&eacute;finies.</p></dd></dl></section></section></section><section class="chapter"><h2 id="introduction-sur-rego" data-toc="introduction-sur-rego">Introduction sur Rego</h2><p id="h6a3s2_68">Rego est le langage de requ&ecirc;te utilis&eacute; par Open Policy Agent (OPA) pour d&eacute;finir et appliquer des politiques. Il est con&ccedil;u pour &ecirc;tre d&eacute;claratif, ce qui signifie qu'il faut d&eacute;crire ce qui doit &ecirc;tre fait plut&ocirc;t que comment le faire. Rego permet d'&eacute;crire des r&egrave;gles logiques qui s'ex&eacute;cutent sur des donn&eacute;es JSON.</p><section class="chapter"><h3 id="exemple-rego" data-toc="exemple-rego">Exemple Rego</h3><div class="code-block" data-lang="rego">
package example.policy

# La règle 'deny' renvoie un message si une condition est violée
deny[msg] {
    input.kind == &quot;Pod&quot;
    input.spec.containers[_].securityContext.readOnlyRootFilesystem == false
    msg = &quot;Les pods doivent utiliser un système de fichiers en lecture seule.&quot;
}
</div><dl id="h6a3s2_71" data-style="title-top"><dt id="h6a3s2_73" data-expandable="false"><code class="code" id="h6a3s2_79">package example.policy</code></dt><dd><p id="h6a3s2_78">D&eacute;finit le package dans lequel cette r&egrave;gle est incluse. Cela permet d'organiser les politiques.</p></dd><dt id="h6a3s2_74" data-expandable="false"><code class="code" id="h6a3s2_82">deny[msg]</code></dt><dd><p id="h6a3s2_81">La r&egrave;gle <code class="code" id="h6a3s2_83">deny</code> s&rsquo;ex&eacute;cute si toutes les conditions d&eacute;finies dans le bloc sont vraies. Si la r&egrave;gle est d&eacute;clench&eacute;e, elle renvoie un message d&rsquo;erreur.</p></dd><dt id="h6a3s2_75" data-expandable="false"><code class="code" id="h6a3s2_86">input.kind == &quot;Pod&quot;</code></dt><dd><p id="h6a3s2_85">V&eacute;rifie que l&rsquo;objet envoy&eacute; en entr&eacute;e est un pod Kubernetes.</p></dd><dt id="h6a3s2_76" data-expandable="false"><code class="code" id="h6a3s2_89">input.spec.containers[_].securityContext.readOnlyRootFilesystem == false</code></dt><dd><p id="h6a3s2_88">Parcourt tous les conteneurs sp&eacute;cifi&eacute;s dans le pod (containers[_]) et v&eacute;rifie si l&rsquo;attribut readOnlyRootFilesystem dans le contexte de s&eacute;curit&eacute; est d&eacute;fini sur <code class="code" id="h6a3s2_90">false</code>.</p></dd></dl><p id="h6a3s2_72">Si les conditions sont satisfaites (par exemple, un conteneur ne respecte pas la configuration), un message est renvoy&eacute; pour expliquer le probl&egrave;me : &quot;Les pods doivent utiliser un syst&egrave;me de fichiers en lecture seule.&quot;</p></section></section><section class="chapter"><h2 id="introduction-sur-k8s-en-yaml" data-toc="introduction-sur-k8s-en-yaml">Introduction sur K8s (en yaml)</h2><p id="h6a3s2_91">Les fichiers YAML sont utilis&eacute;s pour d&eacute;finir l'&eacute;tat souhait&eacute; d'objets dans un cluster. Ces fichiers permettent de sp&eacute;cifier les configurations n&eacute;cessaires pour cr&eacute;er et g&eacute;rer divers objets Kubernetes tels que pods, services, d&eacute;ploiements, etc. Dans le contexte d'OPA Gatekeeper, un fichier YAML est utilis&eacute; pour d&eacute;finir des mod&egrave;les de contraintes (ConstraintTemplate) et des contraintes (Constraint).</p><section class="chapter"><h3 id="exemple-k8s" data-toc="exemple-k8s">Exemple K8s</h3><div class="code-block" data-lang="yaml">
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: UNIQUE_CONSTRAINT_Template_NAME
spec:
  crd:
    spec:
      names:
        kind: sample
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
</div><dl id="h6a3s2_94" data-style="title-top"><dt id="h6a3s2_95" data-expandable="false"><code class="code" id="h6a3s2_103">apiVersion: templates.gatekeeper.sh/v1beta1</code></dt><dd><p id="h6a3s2_102">Sp&eacute;cifie la version de l'API utilis&eacute;e pour d&eacute;finir l'objet. Ici, l'API templates.gatekeeper.sh/v1beta1 est sp&eacute;cifique aux mod&egrave;les de contraintes (ConstraintTemplate) dans OPA Gatekeeper.</p></dd><dt id="h6a3s2_96" data-expandable="false"><code class="code" id="h6a3s2_106">kind: ConstraintTemplate</code></dt><dd><p id="h6a3s2_105">D&eacute;finit le type d'objet Kubernetes. ConstraintTemplate est un mod&egrave;le qui sert de base pour cr&eacute;er des contraintes personnalis&eacute;es dans Gatekeeper.</p></dd><dt id="h6a3s2_97" data-expandable="false"><code class="code" id="h6a3s2_110">metadata</code></dt><dd><p id="h6a3s2_108">Contient des informations standard sur l'objet, telles que :</p><ul class="list _bullet" id="h6a3s2_109"><li class="list__item" id="h6a3s2_111"><p>name : Nom unique de la ressource. Ce nom est utilis&eacute; pour r&eacute;f&eacute;rencer le mod&egrave;le dans d'autres ressources, comme les contraintes.</p></li></ul></dd><dt id="h6a3s2_98" data-expandable="false"><code class="code" id="h6a3s2_114">spec</code></dt><dd><p id="h6a3s2_113">D&eacute;finit les sp&eacute;cifications de la ressource. Pour un ConstraintTemplate, cela inclut deux parties principales :</p></dd><dt id="h6a3s2_99" data-expandable="false"><code class="code" id="h6a3s2_118">crd</code></dt><dd><p id="h6a3s2_116">Permet &agrave; Kubernetes de reconna&icirc;tre et g&eacute;rer les contraintes d&eacute;finies par le mod&egrave;le.</p><ul class="list _bullet" id="h6a3s2_117"><li class="list__item" id="h6a3s2_119"><p><code class="code" id="h6a3s2_120">spec.names.kind: sample</code>: D&eacute;finit le type de contrainte que ce mod&egrave;le prendra en charge. Par exemple, le type personnalis&eacute; ici est appel&eacute; sample.</p></li></ul></dd><dt id="h6a3s2_100" data-expandable="false"><code class="code" id="h6a3s2_124">targets</code></dt><dd><p id="h6a3s2_122">Sp&eacute;cifie la cible pour l&rsquo;application de la politique.</p><ul class="list _bullet" id="h6a3s2_123"><li class="list__item" id="h6a3s2_125"><p><code class="code" id="h6a3s2_127">target: admission.k8s.gatekeeper.sh</code>: Indique que cette politique s'applique aux requ&ecirc;tes intercept&eacute;es par le contr&ocirc;leur d'admission de Kubernetes.</p></li><li class="list__item" id="h6a3s2_126"><p><code class="code" id="h6a3s2_128">rego</code>: Contient le code Rego qui d&eacute;finit la logique de la contrainte. Le contenu de ce bloc sera la r&egrave;gle &eacute;crite en langage Rego pour &eacute;valuer les ressources Kubernetes.</p></li></ul></dd></dl></section></section><section class="chapter"><h2 id="application-d-une-r-gle-rego-sur-un-yaml-k8s" data-toc="application-d-une-r-gle-rego-sur-un-yaml-k8s">Application d'une r&egrave;gle Rego sur un YAML K8s</h2><p id="h6a3s2_129">Dans l'exemple propos&eacute;, la contrainte Rego v&eacute;rifie que les pods n'utilisent pas le champ <code class="code" id="h6a3s2_133">hostNetwork: true</code>, une configuration capable d'exposer des pods directement au r&eacute;seau de la machine h&ocirc;te.</p><section class="chapter"><h3 id="contrainttemplate" data-toc="contrainttemplate">ContraintTemplate</h3><p id="h6a3s2_134">Cr&eacute;ation du mod&egrave;le de contrainte.</p><div class="code-block" data-lang="yaml">
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8shostnetworkdisallowed
spec:
  crd:
    spec:
      names:
        kind: K8sHostNetworkDisallowed
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8shostnetworkdisallowed

        # Détecte les violations lorsque hostNetwork est défini sur true
        violation[{&quot;msg&quot;: msg}] {
          input.review.object.spec.hostNetwork == true
          msg := &quot;The use of hostNetwork: true is not allowed for security reasons.&quot;
        }
</div><dl id="h6a3s2_136" data-style="title-top"><dt id="h6a3s2_137" data-expandable="true" data-expanded="false">metadata</dt><dd><p><b id="h6a3s2_141">name: k8shostnetworkdisallowed</b></p><ul class="list _bullet" id="h6a3s2_142"><li class="list__item" id="h6a3s2_143"><p>Nom unique pour le mod&egrave;le de contrainte. Il identifie clairement la politique appliqu&eacute;e (ici, interdire hostNetwork: true).</p></li><li class="list__item" id="h6a3s2_144"><p>D&eacute;finit la version de l'API utilis&eacute;e pour cr&eacute;er cette contrainte.</p></li></ul></dd><dt id="h6a3s2_138" data-expandable="true" data-expanded="false">spec.crd.spec.names.kind</dt><dd><p><b id="h6a3s2_145">kind: K8sHostNetworkDisallowed</b></p><ul class="list _bullet" id="h6a3s2_146"><li class="list__item" id="h6a3s2_147"><p>Nom du type de contrainte qui sera d&eacute;fini. Les utilisateurs de Gatekeeper utiliseront ce nom pour cr&eacute;er des contraintes sp&eacute;cifiques bas&eacute;es sur ce mod&egrave;le.</p></li></ul></dd><dt id="h6a3s2_139" data-expandable="true" data-expanded="false">targets</dt><dd><p><b id="h6a3s2_148">target: admission.k8s.gatekeeper.sh</b></p><ul class="list _bullet" id="h6a3s2_149"><li class="list__item" id="h6a3s2_150"><p>Sp&eacute;cifie que cette politique s'applique au contr&ocirc;leur d'admission Kubernetes interceptant les requ&ecirc;tes API.</p></li></ul></dd><dt id="h6a3s2_140" data-expandable="true" data-expanded="false">rego</dt><dd><p><b id="h6a3s2_151">La logique</b></p><ul class="list _bullet" id="h6a3s2_152"><li class="list__item" id="h6a3s2_153"><p>violation[{&quot;msg&quot;: msg}] </p><ul class="list _bullet" id="h6a3s2_156"><li class="list__item" id="h6a3s2_157"><p>D&eacute;finit la r&egrave;gle qui d&eacute;tecte les violations. Si une violation est trouv&eacute;e, un message explicatif est renvoy&eacute;.</p></li></ul></li><li class="list__item" id="h6a3s2_154"><p>Condition : input.review.object.spec.hostNetwork == true </p><ul class="list _bullet" id="h6a3s2_158"><li class="list__item" id="h6a3s2_159"><p>V&eacute;rifie si le champ hostNetwork de la sp&eacute;cification du pod est d&eacute;fini sur true.</p></li></ul></li><li class="list__item" id="h6a3s2_155"><p>Message : msg := &quot;The use of hostNetwork: true is not allowed for security reasons.&quot; </p><ul class="list _bullet" id="h6a3s2_160"><li class="list__item" id="h6a3s2_161"><p>Si une violation est d&eacute;tect&eacute;e, ce message est retourn&eacute; pour expliquer pourquoi la requ&ecirc;te est bloqu&eacute;e.</p></li></ul></li></ul></dd></dl></section><section class="chapter"><h3 id="exemple_a" data-toc="exemple_a">Constraint</h3><p id="h6a3s2_162">La Constraint applique le mod&egrave;le d&eacute;fini dans le ContraintTemplate &agrave; des ressources sp&eacute;cifiques.</p><div class="code-block" data-lang="yaml">
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sHostNetworkDisallowed
metadata:
  name: restrict-hostnetwork
spec:
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
    # Facultatif : Filtre par namespace
    namespaces: [&quot;default&quot;, &quot;production&quot;]
</div><dl id="h6a3s2_164" data-style="title-top"><dt id="h6a3s2_165" data-expandable="true" data-expanded="false">apiversion</dt><dd><p><b id="h6a3s2_169">apiVersion: constraints.gatekeeper.sh/v1beta1</b></p><ul class="list _bullet" id="h6a3s2_170"><li class="list__item" id="h6a3s2_171"><p>D&eacute;finit la version de l'API utilis&eacute;e pour cr&eacute;er cette contrainte.</p></li><li class="list__item" id="h6a3s2_172"><p>Le pr&eacute;fixe constraints.gatekeeper.sh est sp&eacute;cifique &agrave; Gatekeeper et permet d&rsquo;appliquer des r&egrave;gles de politique d&eacute;finies &agrave; l&rsquo;aide d&rsquo;un ConstraintTemplate.</p></li></ul></dd><dt id="h6a3s2_166" data-expandable="true" data-expanded="false">kind</dt><dd><p><b id="h6a3s2_173">kind: K8sHostNetworkDisallowed</b></p><ul class="list _bullet" id="h6a3s2_174"><li class="list__item" id="h6a3s2_175"><p>Indique le type de contrainte.</p></li><li class="list__item" id="h6a3s2_176"><p>Ce type doit correspondre &agrave; celui d&eacute;fini dans le ConstraintTemplate.</p></li><li class="list__item" id="h6a3s2_177"><p>Ce lien garantit que cette contrainte applique les r&egrave;gles d&eacute;finies dans le mod&egrave;le associ&eacute;.</p></li></ul></dd><dt id="h6a3s2_167" data-expandable="true" data-expanded="false">metadata</dt><dd><p><b id="h6a3s2_178">name: restrict-hostnetwork</b></p><ul class="list _bullet" id="h6a3s2_179"><li class="list__item" id="h6a3s2_180"><p>Nom unique pour identifier cette contrainte dans le cluster. Cela permet d'appliquer plusieurs contraintes bas&eacute;es sur le m&ecirc;me mod&egrave;le avec des noms diff&eacute;rents.</p></li></ul></dd><dt id="h6a3s2_168" data-expandable="true" data-expanded="false">spec</dt><dd><p><b id="h6a3s2_181">spec.match.kinds</b></p><ul class="list _bullet" id="h6a3s2_182"><li class="list__item" id="h6a3s2_183"><p>apiGroups: [&quot;&quot;] </p><ul class="list _bullet" id="h6a3s2_185"><li class="list__item" id="h6a3s2_186"><p>Sp&eacute;cifie l&rsquo;API group&eacute;e par laquelle les ressources sont expos&eacute;es. Une valeur vide (&quot;&quot;) signifie que l&rsquo;API correspond au groupe de base (ressources standards comme Pod, Service, etc.).</p></li></ul></li><li class="list__item" id="h6a3s2_184"><p>kinds: [&quot;Pod&quot;] </p><ul class="list _bullet" id="h6a3s2_187"><li class="list__item" id="h6a3s2_188"><p>Indique que cette contrainte s&rsquo;applique aux objets de type Pod.</p></li></ul></li></ul></dd></dl></section><section class="chapter"><h3 id="tester-la-contrainte" data-toc="tester-la-contrainte">Tester la contrainte</h3><p id="h6a3s2_189">Cr&eacute;ation d'un Pod avec <code class="code" id="h6a3s2_192">hostNetwork: true</code> pour v&eacute;rifier que la contrainte est appliqu&eacute;e.</p><div class="code-block" data-lang="yaml">
apiVersion: v1
kind: Pod
metadata:
  name: non-compliant-pod
spec:
  hostNetwork: true
  containers:
    - name: nginx
      image: nginx
</div><section class="chapter"><h4 id="r-sultat" data-toc="r-sultat">R&eacute;sultat</h4><div class="code-block" data-lang="bash">
Error from server (Forbidden): admission webhook &quot;validation.gatekeeper.sh&quot; denied the request: 
The use of hostNetwork: true is not allowed for security reasons.
</div></section></section></section><section class="chapter"><h2 id="application-sur-l-instance" data-toc="application-sur-l-instance">Application sur l'instance</h2><p id="h6a3s2_194">Pour respecter la consigne de mise en oeuvre nous proc&eacute;derons comme ceci en utilisant la documentation de K8s et ses capabilities. <br> Sur la machine h&ocirc;te du cluster K8s, il faudra cr&eacute;er les diff&eacute;rents fichiers <code class="code" id="h6a3s2_200">.yaml</code> et les positionner dans un dossier quelconque. <br><br> On pourra imaginer ceci :</p><div class="code-block" data-lang="none">
---home
   |
   ---debian
      |
      ---k8s_yaml
         |
         ---Constraintz
            |
            ---spk8s
               |
               --CT_spk8s.yaml
               --CA_spk8s.yaml
</div><section class="chapter"><h3 id="pr-sence-de-k8s-et-de-gatekeeper" data-toc="pr-sence-de-k8s-et-de-gatekeeper">Pr&eacute;sence de K8s et de Gatekeeper</h3><div class="micro-format" data-content="{&quot;microFormat&quot;:[&quot;\u003cb id\u003d\&quot;h6a3s2_206\&quot;\u003eCheck\u003c/b\u003e&quot;,&quot;\u003cp id\u003d\&quot;h6a3s2_207\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_213\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003eminikube start\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;,&quot;\u003cp id\u003d\&quot;h6a3s2_208\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_214\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003ekubectl get pods -n gatekeeper-system\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;,&quot;\u003cb id\u003d\&quot;h6a3s2_209\&quot;\u003eInstallation\u003c/b\u003e&quot;,&quot;\u003cp id\u003d\&quot;h6a3s2_210\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_215\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003ecurl -LO https://github.com/kubernetes/minikube/releases/latest/download/minikube-linux-amd64\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;,&quot;\u003cp id\u003d\&quot;h6a3s2_211\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_216\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003esudo install minikube-linux-amd64 /usr/local/bin/minikube \u0026amp;\u0026amp; rm minikube-linux-amd64\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;,&quot;\u003cp id\u003d\&quot;h6a3s2_212\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_217\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003ekubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.18.2/deploy/gatekeeper.yaml\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;]}"></div><p id="h6a3s2_204">Pour s'assurer du bon d&eacute;roulement de l'explication, il faut d'abord v&eacute;rifier la pr&eacute;sence d'un K8s (dans ce cas l&agrave;, mis en place par <code class="code" id="h6a3s2_218">minikube</code>) et dans un autre, la pr&eacute;sence de <code class="code" id="h6a3s2_219">Gatekeeper</code>. <br><br> Vous pouvez installer K8s avec <a href="https://minikube.sigs.k8s.io/docs/start/?arch=/linux/x86-64/stable/binary+download" id="h6a3s2_222" data-external="true" rel="noopener noreferrer"><code class="code" id="h6a3s2_230">minikube</code></a> en obtenant les binaires d'installation sur le site officiel. <br> Apr&egrave;s l'installation de <code class="code" id="h6a3s2_224">minikube</code>, et l'avoir d&eacute;marr&eacute;, il faut maintenant installer <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/install/" id="h6a3s2_225" data-external="true" rel="noopener noreferrer"><code class="code" id="h6a3s2_231">Gatekeeper</code></a> en appliquant la configuration sur <code class="code" id="h6a3s2_226">K8s</code>. <br><br> Il faut ensuite v&eacute;rifier son installation et obtenir la m&ecirc;me sortie que celle-ci en executant : <code class="code" id="h6a3s2_229">kubectl get pods -n gatekeeper-system</code>.</p><div class="code-block" data-lang="bash">
NAME                                             READY   STATUS    RESTARTS       AGE
gatekeeper-audit-999899c4-4w2gg                  1/1     Running   2 (8m4s ago)   16h
gatekeeper-controller-manager-68488c48c5-66nb5   1/1     Running   1 (8m4s ago)   16h
gatekeeper-controller-manager-68488c48c5-kl9n5   1/1     Running   1 (8m4s ago)   16h
gatekeeper-controller-manager-68488c48c5-m9lfg   1/1     Running   1 (8m4s ago)   16h
</div></section><section class="chapter"><h3 id="constrainttemplate-application" data-toc="constrainttemplate-application">ConstraintTemplate Application</h3><div class="micro-format" data-content="{&quot;microFormat&quot;:[&quot;\u003cp id\u003d\&quot;h6a3s2_257\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_258\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003ekubectl apply -f CT_spk8s.yaml\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;]}"></div><p id="h6a3s2_232">D&eacute;finition du fichier <code class="code" id="h6a3s2_236">CT_spk8s.yaml</code>.</p><div class="code-block" data-lang="yaml">
apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: spk8s
spec:
  crd:
    spec:
      names:
        kind: SPK8s
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package spk8s

        violation[{&quot;msg&quot;: msg}] {
          input.review.object.spec.containers[_].securityContext.readOnlyRootFilesystem != true
          msg := &quot;Le systeme de fichier n'est pas en lecture seulement.&quot;
        }

        violation[{&quot;msg&quot;: msg}] {
          input.review.object.spec.containers[_].securityContext.allowPrivilegeEscalation == true
          msg := &quot;Attention, l'escalation de privilege est actif.&quot;
        }

        violation[{&quot;msg&quot;: msg}] {
          input.review.object.spec.hostNetwork == true
          msg := &quot;hostNetwork est actuellement actif.&quot;
        }

        violation[{&quot;msg&quot;: msg}] {
          input.review.object.spec.volumes[_].hostPath
          msg := &quot;Les volumes HostPath ne sont pas autorises.&quot;
        }
</div><div class="table-wrapper"><table class="wide" id="h6a3s2_234"><thead><tr class="ijRowHead" id="h6a3s2_237"><th id="h6a3s2_242"><p>Violation</p></th><th id="h6a3s2_243"><p>Type</p></th><th id="h6a3s2_244"><p>Rego</p></th></tr></thead><tbody><tr id="h6a3s2_238"><td id="h6a3s2_245"><p>readOnlyRootFilesystem != true</p></td><td id="h6a3s2_246"><p>Syst&egrave;me de fichiers en lecture seule</p></td><td id="h6a3s2_247"><p>violation[{&quot;msg&quot;: msg}] { input.review.object.spec.containers[_].securityContext.readOnlyRootFilesystem != true msg := &quot;Le systeme de fichier n'est pas en lecture seulement.&quot; }</p></td></tr><tr id="h6a3s2_239"><td id="h6a3s2_248"><p>allowPrivilegeEscalation == true</p></td><td id="h6a3s2_249"><p>Escalade de privil&egrave;ges</p></td><td id="h6a3s2_250"><p>violation[{&quot;msg&quot;: msg}] { input.review.object.spec.containers[_].securityContext.allowPrivilegeEscalation == true msg := &quot;Attention, l'escalation de privilege est actif.&quot; }</p></td></tr><tr id="h6a3s2_240"><td id="h6a3s2_251"><p>hostNetwork == true</p></td><td id="h6a3s2_252"><p>Utilisation du r&eacute;seau de l'h&ocirc;te</p></td><td id="h6a3s2_253"><p>violation[{&quot;msg&quot;: msg}] { input.review.object.spec.hostNetwork == true msg := &quot;hostNetwork est actuellement actif.&quot; }</p></td></tr><tr id="h6a3s2_241"><td id="h6a3s2_254"><p>volumes[_].hostPath</p></td><td id="h6a3s2_255"><p>Restriction des volumes HostPath</p></td><td id="h6a3s2_256"><p>violation[{&quot;msg&quot;: msg}] { input.review.object.spec.volumes[_].hostPath msg := &quot;Les volumes HostPath ne sont pas autorises.&quot; }</p></td></tr></tbody></table></div></section><section class="chapter"><h3 id="constraint-application" data-toc="constraint-application">Constraint Application</h3><div class="micro-format" data-content="{&quot;microFormat&quot;:[&quot;\u003cp id\u003d\&quot;h6a3s2_267\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_268\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003ekubectl apply -f CA_spk8s.yaml\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;]}"></div><p id="h6a3s2_259">D&eacute;finition du fichier <code class="code" id="h6a3s2_263">CA_spk8s.yaml</code>.</p><div class="code-block" data-lang="yaml">
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: SPK8s
metadata:
  name: k8s-security-policies
spec:
  match:
    kinds:
      - apiGroups: [&quot;&quot;]
        kinds: [&quot;Pod&quot;]
</div><aside class="prompt" data-type="note" data-title="" id="h6a3s2_261"><p>Il est possible de filtrer une r&egrave;gle Constraint par namespace en ajoutant dans la section <b id="h6a3s2_264">&quot;match&quot;</b> la ligne <b id="h6a3s2_265">&quot;namespaces: [&quot;default&quot;, &quot;production&quot;]&quot;</b> pr&eacute;sente dans <a href="#exemple_a" id="h6a3s2_266" data-tooltip="La Constraint applique le modèle défini dans le ContraintTemplate à des ressources spécifiques.">l'exemple</a>.</p></aside></section></section><section class="chapter"><h2 id="debug" data-toc="debug">Debug</h2><section class="chapter"><h3 id="error-resource-mapping-not-found" data-toc="error-resource-mapping-not-found">error: resource mapping not found</h3><div class="micro-format" data-content="{&quot;microFormat&quot;:[&quot;\u003cp id\u003d\&quot;h6a3s2_278\&quot;\u003eCommande: \u003ckbd class\u003d\&quot;keystroke\&quot; id\u003d\&quot;h6a3s2_279\&quot; data-bypass\u003d\&quot;true\&quot;\u003e\u003cspan class\u003d\&quot;keystroke__value\&quot;\u003ekubectl describe ConstraintTemplate -o wide\u003c/span\u003e\u003c/kbd\u003e\u003c/p\u003e&quot;]}"></div><p id="h6a3s2_270">Lors de l'installation d'une <code class="code" id="h6a3s2_274">ConstraintTemplate</code>, celle-ci peut pr&eacute;senter des erreurs. K8s, dans son application, n'emp&ecirc;chera pas l'&eacute;xecution de la cr&eacute;ation, pour autant, lors de l'application de la <code class="code" id="h6a3s2_275">Constraint</code>, celle-ci d&eacute;clarera que le template n'existe pas.</p><div class="code-block" data-lang="bash">
error: resource mapping not found for name: &quot;disallow-host-network-rule&quot; namespace: &quot;&quot; from &quot;ee.yaml&quot;: no matches for kind &quot;HostNetworkUsagea&quot; in version &quot;constraints.gatekeeper.sh/v1beta1&quot;
ensure CRDs are installed first
</div><p id="h6a3s2_272"><br> Il est alors possible d'utiliser la commande <code class="code" id="h6a3s2_277">kubectl describe ConstraintTemplate -o wide</code> pour obtenir des d&eacute;tails lors d'erreurs dans la cr&eacute;ation des Constraints et corriger celle-ci.</p></section></section><div class="last-modified">Last modified: 10 janvier 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="acceuil.html" class="navigation-links__prev">Acceuil</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.10.0-b575/app.js"></script></body></html>